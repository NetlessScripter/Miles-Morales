local J = {}

local L = {}

local function ev(n)
	local e = {}
	e.__index = e
	function e.new(...)
		return setmetatable({a={...}},e)
	end
	function e:post()
		local t = L[n]
		if not t then return end
		for i=1,#t do
			t[i](self)
		end
	end
	return e
end

function J.on(n,f)
	L[n]=L[n] or {}
	L[n][#L[n]+1]=f
end

J.GetSongInfo=ev("GetSongInfo")
J.SongStateChanged=ev("SongStateChanged")

local function ex(p)
	return isfile and isfile(p)
end

local function sz(p)
	if not ex(p) then return "0.00MB" end
	return string.format("%.2fMB",#readfile(p)/1024/1024)
end

J.Song={}
J.Song.__index=J.Song

function J.Song.new(m,p)
	return setmetatable({m=m,p=p},J.Song)
end

function J.Song:metadata()
	return self.m
end

function J.Song:path()
	return self.p
end

J.Nongs={}
J.Nongs.__index=J.Nongs

function J.Nongs.new(id,s)
	return setmetatable({id=id,s=s,a=1},J.Nongs)
end

function J.Nongs:songID()
	return self.id
end

function J.Nongs:active()
	return self.s[self.a]
end

function J.Nongs:isDefaultActive()
	return self.a==1
end

function J.Nongs:setActive(i)
	self.a=i
	J.SongStateChanged.new(self):post()
end

J.NongManager={
	d={},
	p=nil,
	i=false
}

function J.NongManager:init()
	self.i=true
end

function J.NongManager:adjustSongID(id,r)
	if r then return -id-1 end
	return id
end

function J.NongManager:hasSongID(id)
	return self.d[id]~=nil
end

function J.NongManager:getNongs(id)
	return self.d[id]
end

function J.NongManager:setNongs(id,n)
	self.d[id]=n
end

function J.NongManager:getFormattedSize(p)
	return sz(p)
end

J.Audio={}

function J.Audio:resolvePath(id)
	J.NongManager.p=nil
	local n=J.NongManager:getNongs(id)
	if not n then return nil end
	local s=n:active()
	local p=s:path()
	if not p or not ex(p) then return nil end
	J.NongManager.p=n
	return p
end

function J.Audio:applyStartOffset(s)
	local n=J.NongManager.p
	if not n then return end
	local o=n:active():metadata().startOffset or 0
	s.TimePosition=o
end

J.Download={}

function J.Download:onSongInfoResolved(n,a,id)
	J.GetSongInfo.new(n,a,id):post()
end

function J.Download:overrideSongInfo(id,info)
	local n=J.NongManager:getNongs(id)
	if not n then return info end
	local s=n:active()
	info.Name=s:metadata().name
	info.Artist=s:metadata().artist
	return info
end

J.Level={}

function J.Level:getAudioForLevel(l)
	if l.songID~=0 then return nil end
	local id=(-l.audioTrack)-1
	return J.Audio:resolvePath(id)
end

J.UI={}

function J.UI:getDisplaySongName(id)
	local n=J.NongManager:getNongs(id)
	if not n then return nil end
	return n:active():metadata().name
end

return J
